<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>How objects are constructed and set up in QML â€” Quite Meticulous Logic</title>
	<meta name="description" content="Title: How objects are constructed and set up in QML; Date: 2024-08-20; Author: Michael Hasselmann">
	<meta name="author" content="Michael Hasselmann">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!--[if lt IE 9]>
		<script src="https://mikhas.github.io/blog/theme/html5.js"></script>
		<![endif]-->
	<link href="https://mikhas.github.io/blog/theme/css/ipython.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	<link href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/simplex/bootstrap.min.css" rel="stylesheet">
	<link href="https://mikhas.github.io/blog/theme/css/local.css" rel="stylesheet">
	<link href="https://mikhas.github.io/blog/theme/css/pygments.css" rel="stylesheet">
</head>
<body>
<div class="container">
	<div class="page-header">
		<h1><a href="https://mikhas.github.io/blog/">Quite Meticulous Logic</a>
		</h1>
	</div>
	<div class="row">
		<div class="col-md-8 col-md-offset-2">
<div class="article" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="text-center article-header">
		<h1 itemprop="name headline" class="article-title">How objects are constructed and set up in QML</h1>
		<span itemprop="author" itemscope itemtype="http://schema.org/Person">
			<h4 itemprop="name">Michael Hasselmann</h4>
		</span>
		<time datetime="2024-08-20T00:00:00+02:00" itemprop="datePublished">Tue 20 August 2024</time>
	</div>
	<div>
		Category:
		<span itemprop="articleSection">
			<a href="https://mikhas.github.io/blog/category/starter-kit.html" rel="category">Starter Kit</a>
		</span>
	</div>
 
	<div>
		Tags:
		<span itemprop="keywords">
			<a href="https://mikhas.github.io/blog/tag/qml.html" rel="tag">QML</a>
		</span>
	</div>
	<div itemprop="articleBody" class="article-body"><div class="section" id="making-a-new-type">
<h2>Making a new type</h2>
<p>Here's how you derive a new class from a base class in pure QML, with a public
API of two mandatory properties. They serve as arguments for new objects.</p>
<pre class="code qml literal-block">
<span class="kr">import</span> <span class="nx">QtQuick</span>

<span class="nx">QtObject</span> <span class="p">{</span>
    <span class="nx">required</span> <span class="nx">property</span> <span class="kr">int</span> <span class="nx">amount</span>
    <span class="nx">required</span> <span class="nx">property</span> <span class="nx">url</span> <span class="nx">iconSource</span>
<span class="p">}</span>
</pre>
<p>The name of the new class, or QML component, is derived from the file name. So
if the file name is <tt class="docutils literal">Derived.qml</tt>, the new type will be available under
<tt class="docutils literal">Derived</tt>.</p>
<p>In Python, an equivalent version could look like so:</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span><span class="w">
</span><span class="kn">from</span> <span class="nn">PySide6.QtCore</span> <span class="kn">import</span> <span class="n">QObject</span><span class="w">


</span><span class="k">class</span> <span class="nc">Derived</span><span class="p">(</span><span class="n">QObject</span><span class="p">):</span><span class="w">
</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">icon_source</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">QObject</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span><span class="w">
</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span><span class="w">
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_amount</span> <span class="o">=</span> <span class="n">amount</span><span class="w">
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_icon_source</span> <span class="o">=</span> <span class="n">icon_source</span>
</pre>
<p>We'll get to the ominous <tt class="docutils literal">parent</tt> parameter in a moment.</p>
<p>If we wanted, we could override QML's filename-to-type mapping in a special
module file called <tt class="docutils literal">qmldir</tt>:</p>
<pre class="code literal-block">
module HowTo.Ctors

Derived 1.0 Derived.qml
Main 1.0 Main.qml
</pre>
</div>
<div class="section" id="multi-phase-construction">
<h2>Multi-phase construction</h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">How the QML engine internally constructs objects is much more complicated.
The information presented here serves as a conceptual overview only.</p>
</div>
<p>In the first phase of construction, the QML engine calls a hidden constructor
similar to the Python constructor shown above and injects the <tt class="docutils literal">parent</tt>
argument.</p>
<p>We now have an instance of our <tt class="docutils literal">Derived</tt> component, but the properties that
we declared as required aren't initialised just yet. The QML engine would
complain with a fatal error if we tried to use the instance in this state.</p>
<p>The <tt class="docutils literal">parent</tt> points to the object that will take ownership over this new
object. In QML, this parent-child relationship is commonly expressed through
nesting:</p>
<div class="highlight"><pre><span></span><span class="nx">Parent</span> <span class="p">{</span>          <span class="c1">// owns the Child instance</span>
    <span class="nx">Child</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span> <span class="c1">// `parent` property will refer to Parent instance</span>
<span class="p">}</span>
</pre></div>
<p>In the second phase, the initial state of the new object is set up. This
happens by evaluating the expressions that are bound to the properties:</p>
<pre class="code qml literal-block">
<span class="nx">Derived</span> <span class="p">{</span>
    <span class="k">amount:</span> <span class="mi">5</span>
    <span class="k">iconSource:</span> <span class="s2">&quot;other/path/to/icon.png&quot;</span>
<span class="p">}</span>
</pre>
<p>Evaluation happens property by property and in random order. This has far
reaching consequences! Properties can depend on other properties and the QML
engine will try its best to resolve the dependencies. It's up to the developer
however to prevent circular dependencies:</p>
<pre class="code qml literal-block">
<span class="nx">Derived</span> <span class="p">{</span>
    <span class="k">amount:</span> <span class="nb">String</span><span class="p">(</span><span class="nx">iconSource</span><span class="p">).</span><span class="nx">length</span> <span class="c1">// Don't #1
</span>    <span class="k">iconSource:</span> <span class="err">`</span><span class="nx">path</span><span class="o">/</span><span class="nx">to</span><span class="o">/</span><span class="nx">icon</span><span class="o">-</span><span class="nx">$</span><span class="p">{</span><span class="nx">amount</span><span class="p">}.</span><span class="nx">png</span><span class="err">`</span> <span class="c1">// Don't #2
</span><span class="p">}</span>
</pre>
<p>The QML engine cannot resolve this. Individually, each property and their
dependency on the other property would be fine. Combined however, this spells
doom and we'll be greeted by the infamous binding loop warning:</p>
<div class="highlight"><pre><span></span>QML Derived: Binding loop detected for property &quot;amount&quot;
</pre></div>
<p>Not all binding loops can be detected by the engine. When that happens, the
application will either hang or crash.</p>
<p>In the third phase, when all bound property expressions have been evaluated
once, <tt class="docutils literal">Component.onCompleted</tt> will be called. This allows us to run code
after the object has been instantiated but before it'll be used by others.</p>
<pre class="code qml literal-block">
<span class="nx">Derived</span> <span class="p">{</span>
    <span class="k">amount:</span> <span class="mi">5</span>
    <span class="k">iconSource:</span> <span class="s2">&quot;other/path/to/icon.png&quot;</span>

    <span class="k">Component.onCompleted:</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="k">amount:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">amount</span><span class="p">},</span> <span class="k">iconSource:</span> <span class="s2">&quot;${iconSource}&quot;</span><span class="err">`</span><span class="p">)</span>
<span class="p">}</span>
</pre>
<p>We can also attach new properties to an existing type:</p>
<pre class="code qml literal-block">
<span class="nx">Derived</span> <span class="p">{</span>
    <span class="nx">readonly</span> <span class="nx">property</span> <span class="nx">string</span> <span class="k">label:</span> <span class="s2">&quot;A new property&quot;</span>

    <span class="k">amount:</span> <span class="mi">7</span>
    <span class="k">iconSource:</span> <span class="s2">&quot;path/to/icon.png&quot;</span>

    <span class="k">Component.onCompleted:</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="k">label:</span> <span class="nx">$</span><span class="p">{</span><span class="nx">label</span><span class="p">}</span><span class="err">`</span><span class="p">)</span>
<span class="p">}</span>
</pre>
<p>This triggers an additional construction phase: Because of the new property,
the QML engine has to derive a new implicit type from our original <tt class="docutils literal">Derived</tt>
component. This new type contains the injected <tt class="docutils literal">label</tt> property. As a new
type, it also has its own <tt class="docutils literal">Component.onCompleted</tt> handler which will run
after <tt class="docutils literal">label</tt> has been evaluated once.</p>
</div>
<div class="section" id="recursive-construction">
<h2>Recursive construction</h2>
<p>It is not guaranteed that all phases of object instantiation run one after
another. For instance, object <tt class="docutils literal">A</tt> could be created before object <tt class="docutils literal">B</tt>, but
properties will be evaluated for <tt class="docutils literal">B</tt> before <tt class="docutils literal">A</tt>'s property are checked.
Therefore, <tt class="docutils literal">B</tt> could reach full initialisation before <tt class="docutils literal">A</tt>.</p>
<p>In the general case, innermost objects will be fully initialised before any
other object.</p>
<div class="highlight"><pre><span></span><span class="nx">Ancestor</span> <span class="p">{</span> <span class="c1">// last to be fully initialised</span>
    <span class="nx">Parent</span> <span class="p">{</span> <span class="c1">// second to be fully initialiased</span>
        <span class="nx">Child</span> <span class="p">{}</span> <span class="c1">// first to be fully initialised</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Your outermost object will usually be the <tt class="docutils literal">ApplicationWindow</tt>, so it'll be
constructed last. The recursive construction spans all the QML components over
as many files as necessary that are ultimately involved in making of the
<tt class="docutils literal">ApplicationWindow</tt>, with each component following the multi-phase
instantiation process.</p>
</div>
</div>
	<hr>
</div>
		</div>
	</div> 	<!-- <hr> -->
</div> <!-- /container -->
<footer class="aw-footer bg-danger">
	<div class="container"> <!-- footer -->
		<div class="row">
			<div class="col-md-10 col-md-offset-1">
				<div class="row">
					<div class="col-md-3">
						<h4>Navigation</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://mikhas.github.io/blog">Quite Meticulous Logic</a></li>
							<li><a href="https://mikhas.github.io/blog/feeds/all.atom.xml" type="application/atom+xml"><i class="fa fa-rss "></i> atom</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Author</h4>
                                                Michael Hasselmann
					</div>
					<div class="col-md-3">
						<h4>Categories</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://mikhas.github.io/blog/category/starter-kit.html">Starter Kit (1)</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</footer>
</div>
</body>
</html>